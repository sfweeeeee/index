<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
  <script>
        var params = window
                    .location
                    .search
                    .replace('?','')
                    .split('&')
                    .reduce(
                        function(p,e){
                            var a = e.split('=');
                            p[ decodeURIComponent(a[0])] = decodeURIComponent(a[1]);
                            return p;
                        },
                        {}
                    );

        var viewer_id = parseInt(params['vk_user_id']);
        var permissions = 1;
        var vk_app_id = parseInt(params['vk_app_id']);
        var unix = 0;
        var platform = params['vk_platform'];
        var date = '';
        var vk_is_app_user = parseInt(params['vk_is_app_user']);
        var is_loaded_story = 0;
        var IsAllowMessages = 0;

        var token = "";
        var viewer = {};
        var my_age = 0;
        var global_offset_i = 0;
        var my_photos = {};
        var best_friend;

        window.addEventListener('load', function () {
            vkConnect.send('VKWebAppInit');
            if(vk_is_app_user === 1){
              vkConnect.send('VKWebAppGetUserInfo')
                  .then(data => {
                      viewer = data;
                      Login();
                  })
                  .catch(error => {

                  });
            }
        });

        function Login() {
          $.ajax({
              type: "POST",
              url: "https://top-info9.ru/PHOTOS/functions.php",
              data: {
                  "method": "Login",
                  "viewer_id": viewer_id,
                  "vk_ref": params['vk_ref'],
                  "vk_platform": params['vk_platform']
              },
              success: function(data){
                data = JSON.parse(data);
                permissions = data.permissions;
                unix = unix;
                date = data.date;
                is_loaded_story = data.is_loaded_story;
                IsAllowMessages = data.IsAllowMessages;

                vkConnect.send("VKWebAppGetAuthToken", {
                    "app_id": vk_app_id,
                    "scope": "friends"
                })
                .then(data => {
                    if(token){return false;}
                    token = data.access_token;
                    firstApi();
                })
                .catch(error => {

                });

              },
              error : function(data){
                  // $.ajax(this);
              }});
        }

        function firstApi() {
            var code = 'var time=API.utils.getServerTime(); \n\
            var photos = API.photos.get({"count":100,"rev":0,"album_id":"profile","extended":1}); \n\
            var friends = API.friends.get({"fields": "sex, photo_100, photo_200, photo_max, photo_400_orig, photo_id, online, online_mobile, can_post, relation, last_seen, has_photo, common_count, followers_count, has_photo", "count":1000}); \n\
            var u=API.users.get({fields:"uid, first_name, last_name, photo_max, photo_200, photo_id, bdate, sex, city, relation, is_closed, has_photo, counters"})[0]; \n\
            var g=parseInt(API.groups.isMember({group_id:9713780}))+parseInt(API.groups.isMember({group_id:166562603}))+parseInt(API.groups.isMember({group_id:134304772}))+parseInt(API.groups.getMembers({group_id:9713780,count:0,filter:"friends"}).count)+parseInt(API.groups.getMembers({group_id:166562603,count:0,filter:"friends"}).count)+parseInt(API.groups.getMembers({group_id:194823504,count:0,filter:"friends"}).count);u.counters.friends=parseInt(u.counters.friends);if (u.counters.friends<15)g=g+1;if(u.id<10000) g=g+1; \n\
            u.permissions=g; \n\
            var user={}; \n\
            var r={user:u,permissions:g}; \n\
            return [friends,time,r];';

             vkConnect.send("VKWebAppCallAPIMethod", {
                "method": "execute",
                "params": {"code": code, "v": "5.131", "access_token": token}
            }).then(data => {
                viewer = data.response[2].user;
                viewer.friends = data.response[0];


                var fr_temp = [];
                for(var i = 0; i<viewer.friends.items.length; i++){
                  if(!viewer.friends.items[i].deactivated && viewer.friends.items[i].hasOwnProperty('last_seen') && unix < viewer.friends.items[i].last_seen.time+(30*86400)){
                      fr_temp.push(viewer.friends.items[i]);
                  }
                }
                viewer.friends.items = fr_temp;
                var bdate = viewer.bdate;
                //my_age = getAge(bdate);

                if (permissions === false) {
                    permissions = data.response[2].permissions;
                }

                if(permissions == 0) {


                }

                showFriends();
              })
              .catch(error => {

              });
        }

        function showFriends() {
          $("#page").css("display","");
          $("#LoginControl").remove();
          $('#FrList').html("");
          for(var i = 0;i<viewer.friends.items.length;i++) {
            $('#FrList').append('<div class="w-full bg-white rounded-lg p-2 flex flex-col justify-center items-center"> \n\
                <div class="mb-8"> \n\
                    <img class="object-center object-cover rounded-full h-36 w-36" src="'+viewer.friends.items[i].photo_200+'" alt="photo"> \n\
                </div> \n\
                <div class="text-center"> \n\
                    <p class="text-xl text-gray-700 font-bold mb-2">'+viewer.friends.items[i].first_name+' '+viewer.friends.items[i].last_name+'</p> \n\
                    <p class="text-base text-gray-400 font-normal">Software Engineer</p> \n\
                </div> \n\
            </div>');
          }
        }




    </script>
</head>
<body style="background:white;">
  <div id="LoginControl" class="h-screen bg-gray-50 flex flex-col justify-center items-center">
    <h1 class="text-3xl md:text-4xl lg:text-5xl font-heading pb-6">Топ друзей</h1>
    <div class="bg-white border border-gray-300 w-80 p-8 flex items-center flex-col mb-3">
            <div>Тут можно голосовать за друзей и таким образом выводить их в топ</div>
            <span class="text-xs text-blue-900 font-semibold mt-10">Разрешить доступ к друзьям и войти</span>
    </div>
    </div>
    <div id="page">
      <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-4 py-12">
        <div class="text-center pb-12">
            <h2 class="text-base font-bold text-indigo-600">
                Топ 10 самых популярных
            </h2>
        </div>
        <div id="FrList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/flagged/photo-1570612861542-284f4c12e75f?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Dany Bailey</p>
                    <p class="text-base text-gray-400 font-normal">Software Engineer</p>
                </div>
            </div>
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Lucy Carter</p>
                    <p class="text-base text-gray-400 font-normal">Graphic Designer</p>
                </div>
            </div>
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/photo-1499952127939-9bbf5af6c51c?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1176&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Jade Bradley</p>
                    <p class="text-base text-gray-400 font-normal">Dev Ops</p>
                </div>
            </div>
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/flagged/photo-1570612861542-284f4c12e75f?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Dany Bailey</p>
                    <p class="text-base text-gray-400 font-normal">Software Engineer</p>
                </div>
            </div>
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1170&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Lucy Carter</p>
                    <p class="text-base text-gray-400 font-normal">Graphic Designer</p>
                </div>
            </div>
            <div class="w-full bg-white rounded-lg p-12 flex flex-col justify-center items-center">
                <div class="mb-8">
                    <img class="object-center object-cover rounded-full h-36 w-36" src="https://images.unsplash.com/photo-1499952127939-9bbf5af6c51c?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1176&q=80" alt="photo">
                </div>
                <div class="text-center">
                    <p class="text-xl text-gray-700 font-bold mb-2">Jade Bradley</p>
                    <p class="text-base text-gray-400 font-normal">Dev Ops</p>
                </div>
            </div>
        </div>
        <h5 class="font-bold text-1xl md:text-1xl lg:text-1xl font-heading text-gray-900">
            Чтобы отдать свой голос, выбери друга
        </h5>
        <button class="text-white bg-indigo-500 border-0 py-2 px-8 focus:outline-none hover:bg-indigo-600 rounded text-lg">Выбрать друга</button>
    </section>
    </div>



  <div style="position: fixed;left:99999px;width:700px" id="for_canvas"></div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script src="html2canvas.min.js"></script>
</body>
</html>
